# 效能優化迷思： 暫存 document 在 DOM 操作中的真實影響

由於圖片中的建議指出，將全域物件（如 `document`）暫存為區域變數可以減少作用域鏈查詢次數，因此理論上應能提升性能。然而，對於這一說法是否在實際情況中有效，我們進行了實作測試。

---

## **疑惑的起點**

[圖片](./image.png)中提到的優化方式是：

1. 每次使用全域物件（如 `document`）會進行作用域鏈查詢，這會浪費性能。
2. 透過將 `document` 暫存為區域變數，可以減少查詢次數，提升性能。

這引發了一個問題：**這種理論上的性能優化，在實際應用中是否真的有效？**

---

### **實作過程**

我們實作了一段代碼，透過兩種方式比較性能：

1. 直接使用 `document.querySelectorAll` 查詢 DOM 節點。
2. 將 `document` 暫存為區域變數後，再使用 `querySelectorAll` 進行查詢。

透過執行測試代碼，我們測量了兩種方式的執行時間。

---

### **測試結果與發現**

1. **測試結果**：
   - `document.querySelectorAll` 的執行耗時主要集中在 DOM 操作本身，而非全域物件的查詢。
   - 暫存 `document` 為區域變數的方式，與直接使用全域 `document` 的性能差異非常小，甚至在某些情境下幾乎可以忽略。

2. **原因分析**：
   - `querySelectorAll` 的性能瓶頸更多來自於 DOM 節點的查詢過程，而非全域物件的作用域鏈查詢。
   - 現代瀏覽器（如 Chrome 的 V8 引擎）對全域物件的查詢已經進行了高度優化，使得這部分開銷極低。

---

### **結論**

基於實作測試，我們發現：

- 圖片中提到的優化方式在理論上是正確的，但在實際應用中，效能提升可能不明顯。
- **性能瓶頸的影響主要取決於操作的內容**：
  - 如果函數頻繁引用全域物件並進行簡單操作（如基於屬性值的讀取），暫存全域物件可能帶來些微提升。
  - 但在涉及大量 DOM 操作的情況下（如 `querySelectorAll` 查詢節點），主要瓶頸在於 DOM 操作本身，而非全域物件的查詢。

---

### **建議**

1. **是否採用圖片建議**：
   - 若代碼需要頻繁訪問全域物件，並且性能要求較高，可考慮暫存全域物件以提升效率。
   - 若性能瓶頸在於 DOM 操作，應優先考慮優化 DOM 查詢（如減少查詢次數或優化選擇器）。

2. **優化應基於實際測試**：
   - 使用瀏覽器的性能分析工具定位瓶頸後，再有針對性地進行優化，而非盲目採用任何優化技巧。

**總結**：圖片提供了一種有價值的性能優化思路，但在實際應用中，效能是否提升需根據情境而定。在性能影響不大的場景下，應更注重代碼的可讀性與簡潔性。
